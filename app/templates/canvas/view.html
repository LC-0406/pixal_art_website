{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-12">
        <!-- 画布信息卡片 -->
        <div class="card">
            <div class="card-header">
                <h3>{{ canvas.title }}</h3>
            </div>
            <div class="card-body">
                <!-- 画布操作按钮 -->
                <div class="canvas-actions" style="margin-bottom: 1.5rem;">
                    {% if current_user.is_authenticated and canvas.user_id == current_user.id %}
                        <a href="{{ url_for('canvas.edit', canvas_id=canvas.id) }}" 
                           class="canvas-btn canvas-btn-edit">
                            编辑画布
                        </a>
                    {% endif %}
                    <a href="{{ url_for('canvas.index') }}" 
                       class="canvas-btn canvas-btn-view">
                        返回列表
                    </a>
                </div>

                <!-- 画布信息 -->
                <div class="canvas-info" style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #4cc9f0;">
                    <div>
                        <span class="canvas-dimensions">{{ canvas.width }} × {{ canvas.height }} 像素</span>
                        <span class="canvas-visibility" style="margin-left: 1rem;">
                            {{ '公开' if canvas.is_public else '私有' }}
                        </span>
                    </div>
                    <div class="canvas-date">
                        创建于: {{ canvas.created_at.strftime('%Y-%m-%d') if canvas.created_at else '未知' }}
                    </div>
                </div>

                <!-- 画布展示区域 -->
                <div class="canvas-display-container" style="background-color: #fff;">
                    <canvas id="canvas-pixels"></canvas>
                </div>

                <!-- 画布作者信息 -->
                <div class="canvas-author" style="margin-top: 2rem; padding-top: 1rem; border-top: 2px dashed rgba(255, 255, 255, 0.1); text-align: center;">
                    <p style="color: #4cc9f0; font-family: 'ChinesePixelFont', 'Courier New', monospace;">
                        创建者: {{ canvas.author.username if canvas.author else '未知用户' }}
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // 画布数据和配置
    const pixelData = {{ canvas.grid_data|safe }};
    const CANVAS_WIDTH = {{ canvas.width }};
    const CANVAS_HEIGHT = {{ canvas.height }};
    const BASE_PIXEL_SIZE = 30; // 基础像素大小
    
    // 获取Canvas元素和上下文
    const canvasPixels = document.getElementById('canvas-pixels');
    const ctxPixels = canvasPixels.getContext('2d');
    
    // 计算实际像素大小（适应容器）
    function calculatePixelSize() {
        const container = canvasPixels.parentElement;
        const containerWidth = container.clientWidth - 40; // 减去padding
        const maxWidth = Math.min(containerWidth, CANVAS_WIDTH * BASE_PIXEL_SIZE);
        return Math.floor(maxWidth / CANVAS_WIDTH);
    }
    
    // 初始化并渲染画布
    function initCanvas() {
        // 计算像素大小
        const pixelSize = calculatePixelSize();
        
        // 设置Canvas的实际大小（像素数）
        canvasPixels.width = CANVAS_WIDTH;
        canvasPixels.height = CANVAS_HEIGHT;
        
        // 设置Canvas的显示大小（CSS像素）
        canvasPixels.style.width = `${CANVAS_WIDTH * pixelSize}px`;
        canvasPixels.style.height = `${CANVAS_HEIGHT * pixelSize}px`;
        canvasPixels.style.imageRendering = 'pixelated';
        
        // 渲染像素
        renderPixels(pixelSize);
    }
    
    // 渲染像素到Canvas
    function renderPixels(pixelSize) {
        // 先清空画布（设置为白色背景）
        ctxPixels.fillStyle = '#FFFFFF';
        ctxPixels.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
        
        // 确保pixelData是有效的数组
        if (!pixelData || !Array.isArray(pixelData)) {
            console.error('无效的像素数据:', pixelData);
            return;
        }
        
        // 绘制每个像素
        for (let y = 0; y < CANVAS_HEIGHT; y++) {
            // 检查行数据是否存在
            if (!pixelData[y]) {
                console.warn(`第${y}行数据不存在`);
                continue;
            }
            
            for (let x = 0; x < CANVAS_WIDTH; x++) {
                const color = pixelData[y][x];
                // 如果有颜色且不是白色，则绘制像素
                if (color && color !== '#FFFFFF' && color !== '#ffffff') {
                    ctxPixels.fillStyle = color;
                    ctxPixels.fillRect(x, y, 1, 1); // 每个像素在canvas中占据1个单位
                }
            }
        }
        
        // 由于我们绘制的是1x1像素，需要放大显示
        // 我们已经在CSS中通过设置style.width/height来放大显示
    }
    
    // 窗口大小改变时重新计算像素大小
    window.addEventListener('resize', function() {
        initCanvas();
    });
    
    // 页面加载完成后初始化画布
    document.addEventListener('DOMContentLoaded', initCanvas);
</script>

<style>
    /* 画布显示容器样式 */
    .canvas-display-container {
        width: 512px;           /* 固定宽度 */
        height: 512px;
        overflow: auto;
        padding: 1.5rem;
        background: #ffffff;
        border: 2px solid rgba(233, 69, 96, 0.3);
        margin-bottom: 1.5rem;
        border-radius: 4px;
        text-align: center; /* 居中显示canvas */
    }
    
    /* Canvas样式 */
    #canvas-pixels {
        display: block;
        margin: 0 auto;
        border: 1px solid #ddd;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        image-rendering: pixelated;
        image-rendering: crisp-edges;
    }
    
    /* 响应式调整 */
    @media (max-width: 768px) {
        .canvas-display-container {
            padding: 1rem;
        }
    }
</style>
{% endblock %}